# Покрытие тестами системы

## Обзор

Система полностью покрыта автотестами с разделением на позитивные и негативные сценарии. Тесты организованы по категориям: API, интеграционные, контрактные и нагрузочные.

## Статистика покрытия

### Общее количество тестов
- **API тесты:** 56+ тестов
- **Интеграционные тесты:** 42+ тестов  
- **Контрактные тесты:** 16+ тестов
- **Нагрузочные тесты:** 4 пользовательских класса

### Разделение по типам
- **Позитивные сценарии:** проверка успешной работы функциональности
- **Негативные сценарии:** проверка обработки ошибок и валидации

## Структура тестов

### 1. API Тесты (`tests/api/`)

#### Позитивные тесты (`TestEndpointPositive`)
- ✅ Успешная аутентификация (LOGIN)
- ✅ Успешное выполнение действия (ACTION) после LOGIN
- ✅ Успешное завершение сессии (LOGOUT)
- ✅ Полный цикл работы с токеном

#### Негативные тесты (`TestEndpointNegative`)
- ✅ Пустой токен
- ✅ None токен
- ✅ Очень длинный токен (>32 символов)
- ✅ Токен со спецсимволами
- ✅ Пустое действие
- ✅ Отсутствующий параметр action
- ✅ Отсутствующий параметр token
- ✅ Действие в нижнем регистре
- ✅ Действие в смешанном регистре
- ✅ Пробелы в токене
- ✅ Пробелы в действии
- ✅ SQL инъекции
- ✅ XSS атаки
- ✅ Таймауты внешних сервисов
- ✅ Повторный LOGIN
- ✅ ACTION после LOGOUT
- ✅ Двойной LOGOUT
- ✅ Неправильный Content-Type
- ✅ Неправильный Accept заголовок
- ✅ Отсутствующий API ключ
- ✅ Неправильный API ключ

### 2. Интеграционные тесты

#### Полные сценарии (`test_auth_flow.py`)
- ✅ Полный цикл: LOGIN -> ACTION -> LOGOUT
- ✅ Множественные ACTION после одного LOGIN
- ✅ ACTION без LOGIN (должен не работать)
- ✅ LOGOUT без LOGIN
- ✅ Независимость разных токенов
- ✅ Повторный LOGIN после LOGOUT

#### Интеграция с внешними сервисами (`test_external_service_integration.py`)
- ✅ LOGIN с успешным ответом mock-сервиса
- ✅ ACTION требует внешний сервис
- ✅ Параллельные токены с внешним сервисом
- ✅ Сохранение состояния после обращения к внешнему сервису
- ✅ Обработка ошибок внешнего сервиса
- ✅ Параллельные LOGIN запросы
- ✅ Параллельные ACTION запросы
- ✅ Обработка недоступности внешнего сервиса
- ✅ Состояние гонки между LOGIN и LOGOUT

#### Негативные интеграционные сценарии (`test_negative_scenarios.py`)
- ✅ Полный цикл с невалидным токеном
- ✅ ACTION после истечения сессии
- ✅ Смешение валидных и невалидных токенов
- ✅ Влияние таймаута внешнего сервиса
- ✅ Быстрый цикл LOGIN-LOGOUT
- ✅ Множественные ACTION после LOGOUT

### 3. Контрактные тесты (`tests/contract/test_openapi.py`)

- ✅ Структура контракта эндпоинта
- ✅ Контракт успешного ответа
- ✅ Контракт ответа с ошибкой
- ✅ Валидация контракта запроса
- ✅ HTTP статус коды
- ✅ Content-Type контракт
- ✅ Формат JSON ответа
- ✅ Контракт для всех действий (LOGIN, ACTION, LOGOUT)

### 4. Нагрузочные тесты (`tests/performance/locustfile.py`)

#### Обычная нагрузка (`SpringBootUser`)
- Симулирует обычное поведение пользователя
- LOGIN при старте, затем ACTION и LOGOUT
- Ожидание между запросами: 1-3 секунды

#### Негативные сценарии под нагрузкой (`SpringBootNegativeUser`)
- Невалидные токены
- ACTION без LOGIN
- Невалидные действия
- Быстрое выполнение (0.5-2 секунды между запросами)

#### Скачки нагрузки (`SpringBootSpikeUser`)
- Резкие изменения нагрузки
- Очень быстрое выполнение (0.1-0.5 секунды)
- Тестирование поведения при скачках

#### Стресс-тестирование (`SpringBootStressUser`)
- Максимальная нагрузка на систему
- Минимальные задержки (0.05-0.2 секунды)
- Тестирование предела производительности

## Покрытие функциональности

### Эндпоинт /endpoint

#### Действие: LOGIN
- ✅ Успешная аутентификация
- ✅ Обработка ошибок внешнего сервиса
- ✅ Таймауты внешнего сервиса
- ✅ Валидация токена (формат, длина)
- ✅ Невалидные запросы
- ✅ Отсутствие API ключа
- ✅ Неправильный API ключ

#### Действие: ACTION
- ✅ Успешное выполнение после LOGIN
- ✅ Ошибка без предварительного LOGIN
- ✅ Обработка ошибок внешнего сервиса
- ✅ Множественные ACTION после одного LOGIN
- ✅ ACTION после LOGOUT
- ✅ Параллельные ACTION запросы

#### Действие: LOGOUT
- ✅ Успешное завершение сессии
- ✅ LOGOUT без предварительного LOGIN
- ✅ Повторный LOGOUT
- ✅ Проверка, что после LOGOUT ACTION не работает

### Безопасность
- ✅ Валидация токенов (формат, длина, спецсимволы)
- ✅ Проверка API ключа
- ✅ Защита от SQL инъекций
- ✅ Защита от XSS атак
- ✅ Валидация входных данных
- ✅ Проверка заголовков (Content-Type, Accept)

### Производительность
- ✅ Обычная нагрузка
- ✅ Скачки нагрузки (spike testing)
- ✅ Стресс-тестирование
- ✅ Негативные сценарии под нагрузкой

## Запуск тестов

### Все тесты
```bash
pdm run pytest
```

### По категориям
```bash
# API тесты
pdm run pytest tests/api/ -m api

# Интеграционные тесты
pdm run pytest tests/integration/ -m integration

# Контрактные тесты
pdm run pytest tests/contract/ -m contract
```

### Позитивные/негативные сценарии
```bash
# Только позитивные тесты
pdm run pytest -m positive

# Только негативные тесты
pdm run pytest -m negative
```

### Нагрузочные тесты
```bash
cd tests/performance
locust -f locustfile.py --host=http://localhost:8080
```

## Генерация отчетов

После запуска тестов отчеты сохраняются в `reports/`:
- `junit.xml` - JUnit XML отчет для CI/CD
- `report.html` - HTML отчет с детальной информацией
- `coverage.md` - Сводный отчет о покрытии (генерируется скриптом)

### Генерация coverage.md
```bash
python3 scripts/generate_coverage_report.py
```

## Маркеры тестов

- `@pytest.mark.api` - API тесты
- `@pytest.mark.integration` - Интеграционные тесты
- `@pytest.mark.contract` - Контрактные тесты
- `@pytest.mark.performance` - Нагрузочные тесты
- `@pytest.mark.positive` - Позитивные сценарии
- `@pytest.mark.negative` - Негативные сценарии
- `@pytest.mark.smoke` - Smoke тесты

## Примечания

- Тесты могут требовать запущенное приложение и WireMock
- Некоторые тесты могут быть пропущены (skipped) при недоступности сервисов
- Нагрузочные тесты запускаются отдельно через Locust
- Отчет `coverage.md` генерируется автоматически при запуске скрипта
